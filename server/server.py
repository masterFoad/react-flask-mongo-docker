import importlib
import sys

from flask import Flask, abort, request, send_from_directory
from flask_cors import cross_origin

print(sys.path)
common_utils = importlib.import_module("common.utils")
config_init_config = importlib.import_module("config.prod_config")
draw_on_img = importlib.import_module("services.draw_on_img")
db_access = importlib.import_module("db.mongo_db")

if config_init_config.current_env == 'dev':
    app = Flask(__name__)
    config_init_config.init_config(app)
else:
    app = Flask(__name__, static_folder='./static/client/build', static_url_path='/')

# common_utils.clean_data()

for x in db_access.img_data_col.find({}):
    print(x)

handlers = importlib.import_module("services.data_handlers")

if config_init_config.current_env == 'prod':
    @app.route('/')
    @cross_origin()
    def index():
        return app.send_static_file('index.html')


    @app.route('/static/images/<path:path>')
    def send_js(path):
        return send_from_directory('static/images', path)


@app.route('/get-list-of-images', methods=['GET'])
@cross_origin()
def get_image_list():
    try:
        return handlers.get_image_list_from_db()
    except Exception as e:
        print(e)
        abort(500)


@app.route('/upload-img-details', methods=['POST'])
@cross_origin()
def handle_uploads():
    return handlers.handle_uploads(request)


if __name__ == '__main__':
    # only used locally
    polgyons_list = [
        [
            [
                310.10597826086956,
                86.97474275023386
            ],
            [
                310.10597826086956,
                127.11693171188027
            ],
            [
                238.7146739130435,
                127.11693171188027
            ],
            [
                238.7146739130435,
                86.97474275023386
            ]
        ],
        [
            [
                475.1983695652174,
                84.7446211412535
            ],
            [
                475.1983695652174,
                129.34705332086062
            ],
            [
                327.9538043478261,
                129.34705332086062
            ],
            [
                327.9538043478261,
                84.7446211412535
            ]
        ],
        [
            [
                1082.0244565217392,
                100.355472404116
            ],
            [
                1082.0244565217392,
                165.0289990645463
            ],
            [
                850.0027173913044,
                165.0289990645463
            ],
            [
                850.0027173913044,
                100.355472404116
            ]
        ],
        [
            [
                950.3967391304348,
                187.33021515434987
            ],
            [
                950.3967391304348,
                207.40130963517305
            ],
            [
                838.8478260869565,
                207.40130963517305
            ],
            [
                838.8478260869565,
                187.33021515434987
            ]
        ],
        [
            [
                1174.526583298393,
                191.25421308155256
            ],
            [
                1355.7562569327977,
                211.01714134394732
            ],
            [
                1351.9560774098272,
                245.83866495501783
            ],
            [
                1170.7264037754226,
                226.07573669262308
            ]
        ],
        [
            [
                296.7201086956522,
                218.55191768007484
            ],
            [
                296.7201086956522,
                240.85313376987838
            ],
            [
                214.17391304347828,
                240.85313376987838
            ],
            [
                214.17391304347828,
                218.55191768007484
            ]
        ],
        [
            [
                383.72826086956525,
                218.55191768007484
            ],
            [
                383.72826086956525,
                240.85313376987838
            ],
            [
                310.10597826086956,
                240.85313376987838
            ],
            [
                310.10597826086956,
                218.55191768007484
            ]
        ],
        [
            [
                992.7853260869565,
                318.9073900841908
            ],
            [
                992.7853260869565,
                343.43872778297475
            ],
            [
                852.2336956521739,
                343.43872778297475
            ],
            [
                852.2336956521739,
                318.9073900841908
            ]
        ],
        [
            [
                227.55978260869566,
                381.3507951356408
            ],
            [
                227.55978260869566,
                405.8821328344247
            ],
            [
                107.08695652173914,
                405.8821328344247
            ],
            [
                107.08695652173914,
                381.3507951356408
            ]
        ],
        [
            [
                845.5407608695652,
                383.58091674462116
            ],
            [
                1008.4021739130435,
                383.58091674462116
            ],
            [
                1008.4021739130435,
                412.5724976613658
            ],
            [
                845.5407608695652,
                412.5724976613658
            ]
        ],
        [
            [
                981.6304347826087,
                486.1665107577175
            ],
            [
                981.6304347826087,
                510.6978484565014
            ],
            [
                858.9266304347826,
                510.6978484565014
            ],
            [
                858.9266304347826,
                486.1665107577175
            ]
        ],
        [
            [
                335.8313676170681,
                642.3539025045311
            ],
            [
                483.0166997080264,
                652.1625446715681
            ],
            [
                481.5458118189936,
                674.2171188939722
            ],
            [
                334.36047972803533,
                664.4084767269352
            ]
        ],
        [
            [
                1021.7880434782609,
                706.9485500467727
            ],
            [
                1021.7880434782609,
                733.710009354537
            ],
            [
                899.0842391304348,
                733.710009354537
            ],
            [
                899.0842391304348,
                706.9485500467727
            ]
        ],
        [
            [
                348.0326086956522,
                840.755846585594
            ],
            [
                348.0326086956522,
                867.5173058933583
            ],
            [
                258.79347826086956,
                867.5173058933583
            ],
            [
                258.79347826086956,
                840.755846585594
            ]
        ],
        [
            [
                921.3940217391305,
                842.9859681945744
            ],
            [
                921.3940217391305,
                867.5173058933583
            ],
            [
                834.3858695652174,
                867.5173058933583
            ],
            [
                834.3858695652174,
                842.9859681945744
            ]
        ],
        [
            [
                78.08423913043478,
                880.8980355472404
            ],
            [
                236.4836956521739,
                880.8980355472404
            ],
            [
                236.4836956521739,
                903.199251637044
            ],
            [
                78.08423913043478,
                903.199251637044
            ]
        ],
        [
            [
                243.17663043478262,
                909.889616463985
            ],
            [
                243.17663043478262,
                934.4209541627689
            ],
            [
                100.39402173913044,
                934.4209541627689
            ],
            [
                100.39402173913044,
                909.889616463985
            ]
        ],
        [
            [
                200.78804347826087,
                950.0318054256314
            ],
            [
                200.78804347826087,
                970.1028999064546
            ],
            [
                80.31521739130434,
                970.1028999064546
            ],
            [
                80.31521739130434,
                950.0318054256314
            ]
        ],
        [
            [
                1528.2201086956522,
                950.0318054256314
            ],
            [
                1528.2201086956522,
                970.1028999064546
            ],
            [
                1452.366847826087,
                970.1028999064546
            ],
            [
                1452.366847826087,
                950.0318054256314
            ]
        ],
        [
            [
                1124.413043478261,
                1010.245088868101
            ],
            [
                1311.8152173913045,
                1010.245088868101
            ],
            [
                1311.8152173913045,
                1039.2366697848456
            ],
            [
                1124.413043478261,
                1039.2366697848456
            ]
        ],
        [
            [
                1523.24411757096,
                1004.1779983848808
            ],
            [
                1524.5311785158904,
                1030.5503025608045
            ],
            [
                1385.561821481456,
                1037.3266925865294
            ],
            [
                1384.2747605365255,
                1010.9543884106057
            ]
        ],
        [
            [
                151.70652173913044,
                1045.9270346117867
            ],
            [
                151.70652173913044,
                1068.2282507015902
            ],
            [
                102.625,
                1068.2282507015902
            ],
            [
                102.625,
                1045.9270346117867
            ]
        ],
        [
            [
                278.8722826086957,
                1081.6089803554723
            ],
            [
                278.8722826086957,
                1108.3704396632368
            ],
            [
                104.85597826086956,
                1108.3704396632368
            ],
            [
                104.85597826086956,
                1081.6089803554723
            ]
        ],
        [
            [
                93.70108695652173,
                1112.8306828811974
            ],
            [
                214.17391304347828,
                1112.8306828811974
            ],
            [
                214.17391304347828,
                1144.0523854069224
            ],
            [
                93.70108695652173,
                1144.0523854069224
            ]
        ],
        [
            [
                916.9320652173914,
                1150.7427502338635
            ],
            [
                916.9320652173914,
                1177.5042095416277
            ],
            [
                825.4619565217391,
                1177.5042095416277
            ],
            [
                825.4619565217391,
                1150.7427502338635
            ]
        ],
        [
            [
                807.6141304347826,
                1155.202993451824
            ],
            [
                807.6141304347826,
                1173.043966323667
            ],
            [
                733.991847826087,
                1173.043966323667
            ],
            [
                733.991847826087,
                1155.202993451824
            ]
        ],
        [
            [
                823.2309782608696,
                1190.8849391955098
            ],
            [
                823.2309782608696,
                1210.956033676333
            ],
            [
                733.991847826087,
                1210.956033676333
            ],
            [
                733.991847826087,
                1190.8849391955098
            ]
        ],
        [
            [
                687.1413043478261,
                1193.1150608044902
            ],
            [
                727.2989130434783,
                1193.1150608044902
            ],
            [
                727.2989130434783,
                1208.7259120673527
            ],
            [
                687.1413043478261,
                1208.7259120673527
            ]
        ],
        [
            [
                1421.133152173913,
                1202.0355472404117
            ],
            [
                1421.133152173913,
                1231.0271281571563
            ],
            [
                1331.8940217391305,
                1231.0271281571563
            ],
            [
                1331.8940217391305,
                1202.0355472404117
            ]
        ],
        [
            [
                845.5407608695652,
                1224.3367633302153
            ],
            [
                845.5407608695652,
                1251.0982226379795
            ],
            [
                756.3016304347826,
                1251.0982226379795
            ],
            [
                756.3016304347826,
                1224.3367633302153
            ]
        ],
        [
            [
                1017.3260869565217,
                1224.3367633302153
            ],
            [
                1017.3260869565217,
                1251.0982226379795
            ],
            [
                850.0027173913044,
                1251.0982226379795
            ],
            [
                850.0027173913044,
                1224.3367633302153
            ]
        ],
        [
            [
                1460.876809825068,
                1477.8590132425163
            ],
            [
                1462.2297761336617,
                1516.6316048146632
            ],
            [
                1174.1615166042163,
                1526.6766801625351
            ],
            [
                1172.8085502956226,
                1487.9040885903883
            ]
        ],
        [
            [
                473.590564644855,
                1541.575237334834
            ],
            [
                660.8697106734567,
                1552.5875517057414
            ],
            [
                659.4541751198146,
                1576.6422117998713
            ],
            [
                472.17502909121305,
                1565.629897428964
            ]
        ],
        [
            [
                274.4103260869565,
                1547.7043966323668
            ],
            [
                274.4103260869565,
                1567.77549111319
            ],
            [
                209.71195652173913,
                1567.77549111319
            ],
            [
                209.71195652173913,
                1547.7043966323668
            ]
        ],
        [
            [
                1427.8260869565217,
                1964.7371375116932
            ],
            [
                1427.8260869565217,
                1989.2684752104772
            ],
            [
                1372.0516304347827,
                1989.2684752104772
            ],
            [
                1372.0516304347827,
                1964.7371375116932
            ]
        ],
        [
            [
                1523.758152173913,
                1964.7371375116932
            ],
            [
                1523.758152173913,
                1991.4985968194574
            ],
            [
                1430.0570652173913,
                1991.4985968194574
            ],
            [
                1430.0570652173913,
                1964.7371375116932
            ]
        ],
        [
            [
                702.758152173913,
                2011.5696913002807
            ],
            [
                702.758152173913,
                2036.1010289990645
            ],
            [
                539.8967391304348,
                2036.1010289990645
            ],
            [
                539.8967391304348,
                2011.5696913002807
            ]
        ],
        [
            [
                867.8505434782609,
                2022.7202993451824
            ],
            [
                867.8505434782609,
                2056.172123479888
            ],
            [
                758.5326086956522,
                2056.172123479888
            ],
            [
                758.5326086956522,
                2022.7202993451824
            ]
        ],
        [
            [
                316.79891304347825,
                2116.3854069223576
            ],
            [
                316.79891304347825,
                2140.9167446211413
            ],
            [
                225.3288043478261,
                2140.9167446211413
            ],
            [
                225.3288043478261,
                2116.3854069223576
            ]
        ],
        [
            [
                1099.8722826086957,
                2147.607109448082
            ],
            [
                1099.8722826086957,
                2172.1384471468664
            ],
            [
                981.6304347826087,
                2172.1384471468664
            ],
            [
                981.6304347826087,
                2147.607109448082
            ]
        ],
        [
            [
                877.3493582684061,
                2266.97687309986
            ],
            [
                1064.2985008903172,
                2273.420868291043
            ],
            [
                1063.4108210024626,
                2299.1519308348925
            ],
            [
                876.4616783805516,
                2292.707935643709
            ]
        ]
    ]
    # list_updated = []
    # for i in polgyons_list:
    #     list_of_t = []
    #     for obj in i:
    #         list_of_t.append(tuple(obj))
    #     list_updated.append(list_of_t)
    # try:
    #     draw_on_img.mark_all_words(
    #         '/Users/foad.a/Downloads/react-flask-mongo-master/server/static/images/polygon_01_GTRF-testcase-10401666614S_Combined-06.jpg',
    #         'testo', list_updated)
    # except Exception as e:
    #     print(e)
    app.run(host='0.0.0.0', port=8080, debug=True)
